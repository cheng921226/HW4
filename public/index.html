<html>

<head>
  <title>台鐵票價查詢</title>
  <link rel="stylesheet" href="/stylesheets/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <h1>台鐵歷史票價查詢系統</h1>
  <div class="container">
    <div class="flex-row">
      <div style="flex:1;min-width:260px;">
        <h2>新增最新票價</h2>
        <form id="insertForm">
          <label>日期: <input type="date" name="effective_date" required></label>
          <label>車種:
            <select name="type_name" id="typeSelect" required>
              <option value="">請選擇車種</option>
              <option value="普通車">普通車</option>
              <option value="柴油車">柴油車</option>
              <option value="快車">快車</option>
              <option value="對號快車">對號快車</option>
              <option value="光華號">光華號</option>
              <option value="通勤車">通勤車</option>
              <option value="觀光號">觀光號</option>
              <option value="宮光號">宮光號</option>
              <option value="自強號">自強號</option>
              <option value="EMU 行駛">EMU 行駛</option>
              <option value="EMU 停駛">EMU 停駛</option>
            </select>
          </label>
          <label>票價/每公里: <input type="number" name="price" step="0.01" required></label>
          <label>備註: <input type="text" name="note"></label>
          <button type="submit">送出</button>
        </form>
      </div>
      <div style="flex:1;min-width:260px;">
        <h2>查詢歷年票價</h2>
        <form id="searchForm">
          <label>日期: <input type="date" name="effective_date"></label>
          <label>車種:
            <select name="type_name" id="searchTypeSelect">
              <option value="">全部車種</option>
              <option value="普通車">普通車</option>
              <option value="柴油車">柴油車</option>
              <option value="快車">快車</option>
              <option value="對號快車">對號快車</option>
              <option value="光華號">光華號</option>
              <option value="通勤車">通勤車</option>
              <option value="觀光號">觀光號</option>
              <option value="宮光號">宮光號</option>
              <option value="自強號">自強號</option>
              <option value="EMU 行駛">EMU 行駛</option>
              <option value="EMU 停駛">EMU 停駛</option>
            </select>
          </label>
          <button type="submit">查詢</button>
        </form>
      </div>
    </div>
    <div class="tables-section">
      <canvas id="trendChart" style="max-width:100%;margin-bottom:32px;"></canvas>
      <div id="tables"></div>
    </div>
  </div>
  <script>
    document.getElementById('insertForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        effective_date: form.effective_date.value,
        type_name: form.type_name.value,
        price: form.price.value,
        note: form.note.value
      };
      try {
        await fetch('/api/insert', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        // 不顯示新增成功訊息
      } catch (err) {
        // 不顯示發送失敗訊息
      }
    });

    // 取得所有資料並顯示在一個組合表格
    async function loadAllTables() {
      const res = await fetch('/api/all');
      const data = await res.json();
      const tablesDiv = document.getElementById('tables');
      // 建立 id 對應表
      const dateMap = {};
      data.ticket_dates.forEach(row => { dateMap[row.date_id] = row; });
      const typeMap = {};
      data.train_types.forEach(row => { typeMap[row.type_id] = row; });
      // 組合 ticket_prices
      let html = '<h2 id="tableTitle">票價歷史紀錄</h2>';
      html += '<table border="1"><tr><th>編號</th><th>日期</th><th>車種</th><th>票價/每公里</th><th>備註</th><th>操作</th></tr>';
      data.ticket_prices.forEach(row => {
        const date = dateMap[row.date_id]?.effective_date || '';
        const type = typeMap[row.type_id]?.type_name || '';
        html += `<tr><td>${row.price_id}</td><td>${date}</td><td>${type}</td><td>${row.price}</td><td>${row.note ?? ''}</td><td><button onclick="deleteRow(${row.price_id})">刪除</button></td></tr>`;
      });
      html += '</table>';
      tablesDiv.innerHTML = html;
    }

    async function renderTrendChart() {
      const res = await fetch('/api/all');
      const data = await res.json();
      // 整理資料：以日期為 X 軸，各車種為線
      const dateMap = {};
      data.ticket_dates.forEach(row => { dateMap[row.date_id] = row.effective_date; });
      const typeMap = {};
      data.train_types.forEach(row => { typeMap[row.type_id] = row.type_name; });
      // 取得所有日期並排序
      const allDates = Array.from(new Set(data.ticket_prices.map(row => dateMap[row.date_id]))).sort();
      // 取得所有車種
      const allTypes = Array.from(new Set(data.train_types.map(row => row.type_name)));
      // 準備各車種的價格資料
      const datasets = allTypes.map((typeName, idx) => {
        // 依日期順序找出該車種在每個日期的價格
        const dataArr = allDates.map(date => {
          const found = data.ticket_prices.find(row => dateMap[row.date_id] === date && typeMap[row.type_id] === typeName);
          return found ? found.price : null;
        });
        // 給每條線不同顏色
        const colors = [
          '#2d5be3', '#e36d2d', '#2de3b6', '#e32d7a', '#e3c82d', '#7a2de3', '#2d9be3', '#e32d2d', '#2de36d', '#2d7ae3', '#e37a2d', '#2de3e3'
        ];
        return {
          label: typeName,
          data: dataArr,
          borderColor: colors[idx % colors.length],
          backgroundColor: colors[idx % colors.length],
          spanGaps: true,
          tension: 0.2
        };
      });
      // 畫圖
      const ctx = document.getElementById('trendChart').getContext('2d');
      if(window.trendChartObj) window.trendChartObj.destroy();
      window.trendChartObj = new Chart(ctx, {
        type: 'line',
        data: {
          labels: allDates,
          datasets: datasets
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'top' },
            title: { display: true, text: '各車種票價歷史走向' }
          },
          scales: {
            y: { title: { display: true, text: '票價/每公里' } },
            x: { title: { display: true, text: '日期' } }
          }
        }
      });
    }

    // 初始載入
    loadAllTables();
    renderTrendChart();
    // 送出表單後也重新載入
    document.getElementById('insertForm').addEventListener('submit', function() {
      setTimeout(() => { loadAllTables(); renderTrendChart(); }, 500);
    });

    // 刪除資料
    async function deleteRow(price_id) {
      if (!confirm('確定要刪除這筆資料嗎？')) return;
      const res = await fetch('/api/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ price_id })
      });
      if (res.ok) {
        loadAllTables();
        renderTrendChart();
      } else {
        alert('刪除失敗');
      }
    }

    async function searchTable(query, showMsg = true) {
      // 取得所有資料
      const res = await fetch('/api/all');
      const data = await res.json();
      // 建立 id 對應表
      const dateMap = {};
      data.ticket_dates.forEach(row => { dateMap[row.date_id] = row; });
      const typeMap = {};
      data.train_types.forEach(row => { typeMap[row.type_id] = row; });
      // 組合 ticket_prices
      let rows = data.ticket_prices.map(row => ({
        price_id: row.price_id,
        date: dateMap[row.date_id]?.effective_date || '',
        type: typeMap[row.type_id]?.type_name || '',
        price: row.price,
        note: row.note ?? ''
      }));
      // 過濾查詢條件
      if (query.effective_date && query.effective_date !== "") rows = rows.filter(r => r.date === query.effective_date);
      if (query.type_name) rows = rows.filter(r => r.type === query.type_name);
      // 顯示表格
      let html = `<h2 id="tableTitle">${showMsg ? '查詢結果' : '票價歷史紀錄'}</h2>`;
      html += '<table border="1"><tr><th>編號</th><th>日期</th><th>車種</th><th>票價/每公里</th><th>備註</th><th>操作</th></tr>';
      rows.forEach(row => {
        html += `<tr><td>${row.price_id}</td><td>${row.date}</td><td>${row.type}</td><td>${row.price}</td><td>${row.note}</td><td><button onclick="deleteRow(${row.price_id})">刪除</button></td></tr>`;
      });
      html += '</table>';
      document.getElementById('tables').innerHTML = html;
    }
    // 查詢表單事件
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      searchTable({
        effective_date: form.effective_date.value,
        type_name: form.type_name.value
      }, true); // 這裡 showMsg 要設為 true
    });
    // 預設顯示全部（不顯示查詢訊息）
    searchTable({}, false);
  </script>
</body>

</html>
